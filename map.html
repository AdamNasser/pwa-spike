
<!--
 Copyright 2016 Google Inc.
 
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at
 
      http://www.apache.org/licenses/LICENSE-2.0
 
 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="canonical" href="https://weather-pwa-sample.firebaseapp.com/final/">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compass Lite</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/styles/inline.css">
  <link rel="manifest" href="/manifest.json">
  <!-- Roboto Webfont -->
<link href='https://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>

  <!-- ios manifest here -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Account Displayer">
<link rel="apple-touch-icon" href="/apple-icon-57x57.png">

  <meta name="msapplication-TileImage" content="apple-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#2F3BA2">

<link href="splashscreens/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
<link href="splashscreens/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
<link href="splashscreens/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
<link href="splashscreens/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
<link href="splashscreens/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
<link href="splashscreens/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
<link href="splashscreens/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />



<style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        margin-top: -300px; 
        z-index: 3001; 
   
       
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
</head>
<body>


<div class="accountdetail" id="detailer">

  <div class="jumbotron" style="background-color: #0F77B8;">
    <span id="closeDetail" class="closeDetailButton" title="Close Overlay">    &ensp;x</span>

  </div>
  

  <div id="mycarousel" class="carousel slide" data-ride="carousel" style="height: 30%; overflow: hidden; background-color: #E9E9E9; margin-top: 70px;" >

    

    <!-- Indicators --> 
    <!-- <ol class="carousel-indicators"> 
      <li data-target="mycarousel" data-slide-to="0" class="active"></li>
      </ol> -->

      <!-- Content --> 
      <div id="carouselParent" class="carousel-inner" role="listbox">

      <!-- Slide 1 --> 
      <div class="item active"> 
        <img id="carouselItem" src="/icons/no_image.jpg" style="height: 3%;">
      </div>

    </div>


<!-- Left and right controls -->
  <a class="left carousel-control" href="#mycarousel" data-slide="prev" >
    <span class="glyphicon glyphicon-chevron-left" ></span>
   
  </a>
  <a class="right carousel-control" href="#mycarousel" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    
  </a>

</div>

<!-- Camera, Upload, and Share Buttons -->

<div class="container" align="center">
<div class="row" style="margin-top: 10px; height: 70px;" align="center">

 

<div class="col-sm" align="center"> 
<input type="file" id="imgupload" style="display:none"/>
<div id="uploadButton" class="filterButton filterButton__push" onclick="$('#imgupload').trigger('click'); return false;">
  <div class="filterButton__ripple"></div>
  <img id="Upload" class="filterButton__image" src="/icons/camera_icon.png" alt="Upload" >
</div>
<p class="filterButtonTitle"> Upload </p>
</div>






</div>

</div>


<h2 id="detailName" class="undercaro">Chipotle</h2>

<p id="detailAddress" class="doubleundercaro"> 3854 Early Light Ave.</p>
<p id="detailCityandState" class="doubleundercaro"> Merced, CA </p>

</div>



<div class = "searchBox" align="center">

   <div class="resultsloader" hidden>
    <svg viewBox="0 0 32 32" width="32" height="32">
      <circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
    </svg>
  </div>

  

   <!-- Search Link -->
<a class="searcher" href="#search">

  
  <i class="fa fa-search"></i> Search

</a>
  

<div class="searchRow" align="center">

<div class="row">
    <div class="col-xs-3" align="center" >


      <div id="foodButton" class="filterButton filterButton__push">
      <div class="filterButton__ripple"></div>
      <img id="Food" class="filterButton__image" src="/icons/food.png" alt="Food" >
    </div>

    
     <p class="filterButtonTitle"> Food </p>

  </div>

    <div class="col-xs-3" align="center">
      
        <div id="drinksButton" class="filterButton filterButton__push">
      <div class="filterButton__ripple"></div>
      <img id="Drinks" class="filterButton__image" src="/icons/drinks.png" alt="Drinks" >

 
    </div>

<p class="filterButtonTitle" align="center"> Drinks </p>

    </div>
    <div class="col-xs-3" align="center">
        <div id="storesButton" class="filterButton filterButton__push">
      <div class="filterButton__ripple"></div>
      <img id="Stores" class="filterButton__image" src="/icons/stores.png" alt="Stores" >
    </div>
 <p class="filterButtonTitle"> Stores </p>

    </div>
    <div class="col-xs-3" align="center">
      
        <div id="brandsButton"class="filterButton filterButton__push">
      <div class="filterButton__ripple"></div>
      <img id="Brands" class="filterButton__image" src="/icons/fireworks.png" alt="Brands" >
    </div>
<p class="filterButtonTitle"> Brands </p>

    </div>

   </div>

 </div> 


 <div class="result_spacing" align="left">Displaying All Results within 50 mile radius</div>

<div class="results__title" >
      
        <div  class="list-group" style="margin-top: 0px;" hidden>
  <a id="resultCell" href="#" class="list-group-item list-group-item-action flex-column align-items-start">
    <div class="d-flex w-100 justify-content-between">
      <h5 id="title" class="mb-1">List group item heading</h5>
      <small id="small_body"></small>
    </div>
    <p id="body" class="mb-1">Donec id elit non mi porta gravida at eget metus. Maecenas sed diam eget risus varius blandit.</p>
    <small id="cityANDstate">Donec id elit non mi porta.</small>
  </a>
</div>
</div>

  


 </div>


<div id="myOverlay" class="overlay">
  <span class="closebtn" title="Close Overlay">x</span>
  <div class="overlay-content">
      <input type="text" placeholder="Search.." name="search">
      <button id="searcherButton" type="submit"><i class="fa fa-search"></i></button>
   
  </div>
</div>


 
  <main class="main"></main>


  <div class="loader">
    <svg viewBox="0 0 32 32" width="32" height="32">
      <circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
    </svg>
  </div>





<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
<script>

  //global token variable

  var myToken; 



  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAJ5X7NGIoS36zuAiKb2Dk5HCOTfj_lOYQ",
    authDomain: "pwa-demo-new.firebaseapp.com",
    databaseURL: "https://pwa-demo-new.firebaseio.com",
    projectId: "pwa-demo-new",
    storageBucket: "gs://pwa-demo-new.appspot.com",
    messagingSenderId: "997650602127"
  };
  firebase.initializeApp(config);


  //ask for push permission here 
  const messaging = firebase.messaging(); 
  messaging.requestPermission().then(function() {
    //get Token 
    return messaging.getToken(); 
  }) .then(function(token) {


      console.log("SUBSCRIBED SUCCESSFULLY"); 

      window.myToken = token; 

      //send token to server here 
      console.log(token); 
  })
      .catch(function(err) {
        console.log(err); 
        console.log("Permission Denied"); 
      }); 


      messaging.onMessage(function(payload) {

        console.log('Message : ', payload); 

      }); 


</script>



<!-- MAP CODE --> 
<div id="map"></div>
    <script type="text/javascript">

      
     var visibleResults = {}; //visible results on list 
     var visiblePins = [];    // visibile pins on map 
     var arrowToggle = false; 
     var controlText; // arrow control div 
     var im = '/icons/usericon.png';
     var currentLocation = {lat: 41.85, lng: -87.65};
     


      function setupDetailButtons() {


              //upload Button and input CHANGE EVENT 
            var uploadButton = document.getElementById("uploadButton"); 
            uploadButton.addEventListener('click', function() {
            });

            var inputSelector = document.getElementById('imgupload'); 
            inputSelector.addEventListener('change', function() { 


                var carousel = document.getElementById("carouselParent"); 
                var carouselItemSelector = document.getElementById("carouselItem"); 
                var carouselItem = carouselItemSelector.cloneNode(true); 



              // do something with files here 
              console.log("detected file change"); 


                readURL(this); 

              //1) display image in carousel 
             // carouselItem.src = this.files[0]; 
              //carouselParent.appendChild(carouselItem); 



              //2) throw image in a bucket 

            }); 


            

      }

      function readURL(input) {
        var url = input.value;
        var ext = url.substring(url.lastIndexOf('.') + 1).toLowerCase();
        if (input.files && input.files[0]&& (ext == "gif" || ext == "png" || ext == "jpeg" || ext == "jpg")) {
            var reader = new FileReader();

           reader.onload = function (e) {
            console.log(e.target.result); 
            document.getElementById("carouselItem").src = e.target.result; 
            //$('#carouselItem').attr('src', e.target.result);
           }

        reader.readAsDataURL(input.files[0]);


          /*DROP IN STORAGE BUCKET */
          const ref = firebase.storage().ref(); 

          const file = input.files[0]; 

          const name = (+new Date()) + '-' + file.name; 

          const metadata = { contentType: file.type };

          const task = ref.child(name).put(file,metadata); 
          task 
            .then(snapshot => snapshot.ref.getDownloadURL()) 
            .then( (url) =>  {
                console.log(url); 
            })
            .catch((error) => {
             console.log(error); 

            }); 
            /*                          */

        }else{
         //$('#img').attr('src', '/assets/no_preview.png');
         console.log("fallback image"); 
       }



       // FOR POC PURPOSES, SEND A PUSH NOTIFICATION 

var key = 'AAAA6EicGI8:APA91bED6cfEyEbfxRMrGwO-i1gJlmCfjrogMEdavCpMPg9F9ypsYt3xlBXbCXzUsPmyJam_xG1u9BlkwpdgQT6RC82z1Z42FXRZid-mh4rsYtQVv3aSiOtFOrTcpka_coUTjXYAlbni';
var to = window.myToken;

console.log("TOKEN:"); 
console.log(to); 

var notification = {
  'title': 'Portugal vs. Denmark',
  'body': '5 to 1',
  'icon': 'firebase-logo.png',
  'click_action': 'http://localhost:8081'
};

fetch('https://fcm.googleapis.com/fcm/send', {
  'method': 'POST',
  'headers': {
    'Authorization': 'key=' + key,
    'Content-Type': 'application/json'
  },
  'body': JSON.stringify({
    'notification': notification,
    'to': to
  })
}).then(function(response) {
  console.log(response);
}).catch(function(error) {
  console.error(error);
})

// END PUSH NOTIFICATION 




  }


     /**
       * The LocationControl adds a control to the map that recenters the map on
       * user's current location.
       * This constructor takes the control DIV as an argument.
       * @constructor
       */
      function CenterControl(controlDiv, map) {

        // Set CSS for the control border.
        var controlUI = document.createElement('div');
         controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
         

        controlUI.title = 'Click to recenter the map';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '16px';
        controlText.style.lineHeight = '38px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = '<img src=\'/icons/target_icon.png\'>';
        controlText.style.marginTop = '22px'; 
        controlText.style.backgroundColor = "";
        controlText.style.opacity = "";  
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        controlUI.addEventListener('click', function() {
          map.setCenter(currentLocation);
          map.setZoom(14); 
        });

      }


      function UpControl(controlDiv, map) {

        // Set CSS for the control border.
        var controlUI = document.createElement('div');
         controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
         

        controlUI.title = 'Click to recenter the map';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '16px';
        controlText.style.lineHeight = '38px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = '<img src=\'/icons/uparrow.png\'>';
        controlText.style.marginTop = '22px'; 
        controlText.style.backgroundColor = "";
        controlText.style.opacity = "";  
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.

        //var searchInput = document.getElementById("mySearch"); 
        var searchSelector = document.querySelector('.searchBox'); 


        controlUI.addEventListener('click', function() {

          if(!arrowToggle) {
          //searchSelector.style.height = "100%"; 
          //searchSelector.style.transform = "translateY(0)"; 
          searchSelector.classList.add('searchBox--show'); 
          //searchInput.style.minHeight = "35px"; 
          //searchInput.style.height = "6%"; 
           controlText.innerHTML = '<img src=\'/icons/downarrow.png\'>';
          changeSearchBoxHeight(searchSelector); 
          arrowToggle = true; 
        } else  {

          searchSelector.classList.remove('searchBox--show'); 
           controlText.innerHTML = '<img src=\'/icons/uparrow.png\'>';
          changeSearchBoxHeight(searchSelector); 
          arrowToggle = false; 

        }


        });

      
      }

      function toggleLoader(isHidden) {
        var loaderSelector = document.querySelector('.resultsloader'); 
        if(isHidden == true){
        loaderSelector.setAttribute('hidden',true); 
      } else {
        loaderSelector.removeAttribute('hidden');
      }

      }


      var resultCount = 0; 

      function clearResultList() {

        console.log("CLEARING"); 

        for(i = 0; i < resultCount; i++) {
          var currentResult = visibleResults[i]; 
          console.log(currentResult + i); 
          //currentResult.parentNode.removeChild(currentResult); 
        }

        resultCount = 0; 


        for (var member in visibleResults) delete visibleResults[member]; 

      }


    function fetchAccounts(latitude,longitude) {


       //clear old result list 
        clearResultList() 

        var locations = []

       var url = 'https://cbi-api-internal-qa.herokuapp.com/v2/beerStores?apiKey=compass-beer&filterUnsold=Y&includeStoreRank=Y&lowerRightBound=37.330966%2C-118.029159&signature=AziYxd1PhDbUvQIAjSBfgb5fs3nsAHeO848/Y4j3FDg%3D&upperLeftBound=37.338737%2C-122.037399';

        // Fetch the latest data.
    fetch(url,{mode: 'cors'})
    .then((response) => response.json())
    .then((responseJson) => {

      console.log(responseJson.length); 


      var resultSelector = document.querySelector('.results__title'); 
        
        for(var i = 0; i < responseJson.length; i++) {
            //assign boostrap list result cell here 
          var currentSelector = document.getElementById("resultCell"); 
          var currentCell = currentSelector.cloneNode(true); 

         var accountName = document.getElementById("title");
         var body = document.getElementById("body");  
         var body2 = document.getElementById("cityANDstate"); 

         if(responseJson[i] != null) {

         accountName.textContent = responseJson[i].store_name; 
         console.log(responseJson[i].store_name); 
         body.textContent = responseJson[i].address; 
         body2.textContent = responseJson[i].city + " , " + responseJson[i].state;

          

          resultSelector.appendChild(currentCell);
          visibleResults[i] = currentCell; 
          resultCount++; 
          console.log("Displaying " + resultCount + " results"); 



          currentCell.addEventListener('click', function() {
      //get active cell's data we already retrieved in fetchAccounts() 
      var name = this.childNodes[1].innerText; 
      var address = this.childNodes[3].innerText; 
      var cityANDstate = this.childNodes[5].innerText; 
      var data = {name,address,cityANDstate}; 
        showAccountDetail(data); 
      console.log("Clicked a result"); 
          }); 


        }
          //REMOVE DEAD CELL 
           if(i === 0) {
              console.log("Found default cell!"); 
              
                currentCell.parentNode.removeChild(currentCell);  }

      }
      resultSelector.removeAttribute('hidden'); 
      toggleLoader(true);  


      })
    }


      function changeSearchBoxHeight(selector) {


        if(!arrowToggle) {
        controlText.innerHTML = '<img src=\'/icons/downarrow.png\'>';
        arrowToggle = true; 

        selector.style.height = "90%";


        //make the loader visible
        toggleLoader(false); 


       

        //fetch data from current location and populate result list 
        fetchAccounts(37,122) 

       
       
        //adjust proportions
        var rowSelector = document.querySelector('.searchRow'); 
        rowSelector.style.height = "12%"; 
 

      } else {
        controlText.innerHTML = '<img src=\'/icons/uparrow.png\'>';
        arrowToggle = false; 
        toggleLoader(true); 
        selector.style.height = "15%"; 
        var resultSelector = document.querySelector('.results__title');resultSelector.setAttribute('hidden',true);


        
        //adjust proportions
        var rowSelector = document.querySelector('.searchRow'); 
        rowSelector.style.height = "80%"; 
      }


      }

      var testScroll = function(evt){
        console.log("Hello?"); 
      }; 
      

      function fetchAccountDetailInfo() {

        var address = document.getElementById("detailAddress"); 
        var cityandstate = document.getElementById("detailCityandState"); 

        //make the fetch 


      }


      function showAccountDetail(accountData) {
        //hide search box 
        var searchBoxSelector = document.querySelector('.searchBox'); 
        searchBoxSelector.setAttribute('hidden',true); 

        console.log("Showing Account Detail"); 
        var accountdetailElement = document.getElementById("detailer"); 
        //accountdetailElement.style.transform = "translateY(50)";
        accountdetailElement.classList.add('accountdetail--show');
        //accountdetailElement.classList.add('menu__overlay--show');



        //set info from accountData parameter
          var name = document.getElementById("detailName"); 
          var address = document.getElementById("detailAddress"); 
          var cityandstate = document.getElementById("detailCityandState"); 

          name.textContent = accountData.name; 
          

          address.textContent = accountData.address; 
          cityandstate.textContent = accountData.cityANDstate; 





    
      }




      function hideAccountDetail() {
        //a wild search box has appeared ! 
        var searchBoxSelector = document.querySelector('.searchBox'); 
        searchBoxSelector.removeAttribute('hidden'); 

        console.log("Hiding Account Detail"); 
        var accountdetailElement = document.getElementById("detailer"); 
        accountdetailElement.classList.remove('accountdetail--show'); 
      }

       
     function initMap() {


      //INITIALIZE ACCOUNT DETAILER CLOSER 
      var closerDetail = document.getElementById("closeDetail"); 
      closerDetail.addEventListener('click', function() {

         hideAccountDetail(); 


      }); 


      //Initialize account detail buttons 
      setupDetailButtons(); 




      //INITIALIZE SEARCH 
      var searchSelector = document.querySelector('.searchBox');
      
      var searcher = document.querySelector('.searcher'); 
      searcher.addEventListener('click', function() {
        console.log("Triggering search overlay"); 

        //change the search box height as well 
        var searchSelector = document.querySelector('.searchBox'); 
        arrowToggle = false; 
        changeSearchBoxHeight(searchSelector); 

        openSearch(); 
      });

      var closesearcher = document.querySelector('.closebtn'); 
      closesearcher.addEventListener('click', function() {
        closeSearch(); 
      }); 

      var searchButton = document.getElementById('searcherButton'); 
      searchButton.addEventListener('click', function() {
          closeSearch(); 
      }); 



  function openSearch() {
  document.getElementById("myOverlay").style.display = "block";
  console.log("Opening Search"); 
}

// Close the full screen search box 
function closeSearch() {
  document.getElementById("myOverlay").style.display = "none";
}



var resultSelector = document.querySelector('.results__title');

      //searchSelector.appendChild(resultSelector); 

      var map; 
      var selectedButton = 5;
      var numberofButtons = 4; 
      var filterButtonArray = new Array(numberofButtons).fill(false); 
      var filterButtonElementArray = new Array(numberofButtons); 
      filterButtonElementArray[0] = document.getElementById("foodButton"); 
      filterButtonElementArray[1] = document.getElementById("drinksButton");
      filterButtonElementArray[2] = document.getElementById("storesButton");
      filterButtonElementArray[3] = document.getElementById("brandsButton"); 
  
  filterButtonElementArray[0].addEventListener('click', function() {

    resetFilters(); 

     if(!filterButtonArray[0]) {

      //display list 
      var selector = document.querySelector('.searchBox'); 
      arrowToggle = false; 
    changeSearchBoxHeight(selector);
    arrowToggle = true; 
    

      
         //make the search 

      //set the map 
      var pos = {
              lat: 37.332099999999997,
              lng: -119.649500000000002
            };
    map.setCenter(pos); 
    map.setZoom(17); 
     }
    

    handleFilterSelection(0); 

  }); 

  filterButtonElementArray[1].addEventListener('click', function () {


  resetFilters(); 


 if(!filterButtonArray[1]) {

     //display list 
      var selector = document.querySelector('.searchBox');
      arrowToggle = false;  
    changeSearchBoxHeight(selector);
    arrowToggle = true; 
    controlText.innerHTML = '<img src=\'/icons/downarrow.png\'>';



         //make the search 

      //set the map 
      var pos = {
              lat: 37.332099999999997,
              lng: -119.649500000000002
            };
    map.setCenter(pos); 
    map.setZoom(17); 
     }

    handleFilterSelection(1); 

    //make the search 

    //set the map

}); 

  filterButtonElementArray[2].addEventListener('click', function() {

    resetFilters(); 

 if(!filterButtonArray[2]) {


      //display list 
      var selector = document.querySelector('.searchBox'); 
      arrowToggle = false; 
    changeSearchBoxHeight(selector);
    arrowToggle = true; 
    controlText.innerHTML = '<img src=\'/icons/downarrow.png\'>';


      
         //make the search 

      //set the map 
      var pos = {
              lat: 37.332099999999997,
              lng: -119.649500000000002
            };
    map.setCenter(pos); 
    map.setZoom(17); 
     }


    handleFilterSelection(2); 
  }); 

  filterButtonElementArray[3].addEventListener('click', function() {

    resetFilters(); 

if(!filterButtonArray[3]) {

       //display list 
      var selector = document.querySelector('.searchBox'); 
      arrowToggle = false; 
    changeSearchBoxHeight(selector);
    arrowToggle = true; 
    controlText.innerHTML = '<img src=\'/icons/downarrow.png\'>';

      
         //make the search 

      //set the map 
      var pos = {
              lat: 37.332099999999997,
              lng: -119.649500000000002
            };
    map.setCenter(pos); 
    map.setZoom(17); 
     }


    handleFilterSelection(3); 
  });

  function handleFilterSelection(index) {



    var currentState = filterButtonArray[index]; 

    if(currentState) {
      filterButtonArray[index] = false; 
      var currentElement = filterButtonElementArray[index]; 
      currentElement.classList.remove('active'); 

    }else {
      filterButtonArray[index] = true; 
       var currentElement = filterButtonElementArray[index]; 
      currentElement.classList.add('active'); 
    }



    
    }


    function resetFilters() {
      //then check if any filters are currently selected and uncheck them 
    for(var i = 0; i < filterButtonArray.length; i++) {
      if(filterButtonArray[i]) {
        filterButtonArray[i] = false; 
        var currentElement = filterButtonElementArray[i]; 
        currentElement.classList.remove('active'); 
      }
    }
    }



  
  

  function changePushStatus(status) {
    console.log(status); 
    drinkButtonElement.dataset.checked = status;
    drinkButtonElement.checked = status;
    if (status) {
      drinkButtonElement.classList.add('active'); 
    }
    else {
      selectedIndex = 5; 
     drinkButtonElement.classList.remove('active');
     
    }
  }



    /**************************************************************************************************************************************

  GEOLOCATION LIBRARY CODE  


**************************************************************************************************************************************/
var b;function e(a,c){function f(){}f.prototype=c.prototype;a.B=c.prototype;a.prototype=new f;a.prototype.constructor=a;for(var g in c)if("prototype"!=g)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(c,g);d&&Object.defineProperty(a,g,d)}else a[g]=c[g]}
function h(a,c,f,g){var d=google.maps.MVCObject.call(this)||this;d.c=null;d.b=null;d.a=null;d.i=-1;var l={clickable:!1,cursor:"pointer",draggable:!1,flat:!0,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#C8D6EC",fillOpacity:.7,scale:12,strokeWeight:0},position:new google.maps.LatLng(0,0),title:"Current location",zIndex:2},m={clickable:!1,cursor:"pointer",draggable:!1,flat:!0,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#4285F4",fillOpacity:1,scale:6,strokeColor:"white",strokeWeight:2},
optimized:!1,position:new google.maps.LatLng(0,0),title:"Current location",zIndex:3};c&&(l=k(l,c));f&&(m=k(m,f));c={clickable:!1,radius:0,strokeColor:"1bb6ff",strokeOpacity:.4,fillColor:"61a0bf",fillOpacity:.4,strokeWeight:1,zIndex:1};g&&(c=k(c,g));d.c=new google.maps.Marker(l);d.b=new google.maps.Marker(m);d.a=new google.maps.Circle(c);google.maps.MVCObject.prototype.set.call(d,"accuracy",null);google.maps.MVCObject.prototype.set.call(d,"position",null);google.maps.MVCObject.prototype.set.call(d,
"map",null);d.set("minimum_accuracy",null);d.set("position_options",{enableHighAccuracy:!0,maximumAge:1E3});d.a.bindTo("map",d.c);d.a.bindTo("map",d.b);a&&d.setMap(a);return d}e(h,google.maps.MVCObject);b=h.prototype;b.set=function(a,c){if(n.test(a))throw"'"+a+"' is a read-only property.";"map"===a?this.setMap(c):google.maps.MVCObject.prototype.set.call(this,a,c)};b.f=function(){return this.get("map")};b.l=function(){return this.get("position_options")};
b.w=function(a){this.set("position_options",a)};b.g=function(){return this.get("position")};b.m=function(){return this.get("position")?this.a.getBounds():null};b.j=function(){return this.get("accuracy")};b.h=function(){return this.get("minimum_accuracy")};b.v=function(a){this.set("minimum_accuracy",a)};
b.setMap=function(a){google.maps.MVCObject.prototype.set.call(this,"map",a);a?navigator.geolocation&&(this.i=navigator.geolocation.watchPosition(this.A.bind(this),this.o.bind(this),this.l())):(this.c.unbind("position"),this.b.unbind("position"),this.a.unbind("center"),this.a.unbind("radius"),google.maps.MVCObject.prototype.set.call(this,"accuracy",null),google.maps.MVCObject.prototype.set.call(this,"position",null),navigator.geolocation.clearWatch(this.i),this.i=-1,this.c.setMap(a),this.b.setMap(a))};
b.u=function(a){this.b.setOptions(k({},a))};b.s=function(a){this.a.setOptions(k({},a))};
b.A=function(a){var c=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),f=!this.b.getMap();if(f){if(null!=this.h()&&a.coords.accuracy>this.h())return;this.c.setMap(this.f());this.b.setMap(this.f());this.c.bindTo("position",this);this.b.bindTo("position",this);this.a.bindTo("center",this,"position");this.a.bindTo("radius",this,"accuracy")}this.j()!=a.coords.accuracy&&google.maps.MVCObject.prototype.set.call(this,"accuracy",a.coords.accuracy);!f&&this.g()&&this.g().equals(c)||google.maps.MVCObject.prototype.set.call(this,
"position",c)};b.o=function(a){google.maps.event.trigger(this,"geolocation_error",a)};function k(a,c){for(var f in c)!0!==p[f]&&(a[f]=c[f]);return a}var p={map:!0,position:!0,radius:!0},n=/^(?:position|accuracy)$/i;var q=window;function r(){h.prototype.getAccuracy=h.prototype.j;h.prototype.getBounds=h.prototype.m;h.prototype.getMap=h.prototype.f;h.prototype.getMinimumAccuracy=h.prototype.h;h.prototype.getPosition=h.prototype.g;h.prototype.getPositionOptions=h.prototype.l;h.prototype.setCircleOptions=h.prototype.s;h.prototype.setMap=h.prototype.setMap;h.prototype.setMarkerOptions=h.prototype.u;h.prototype.setMinimumAccuracy=h.prototype.v;h.prototype.setPositionOptions=h.prototype.w;return h}
"function"===typeof q.define&&q.define.amd?q.define([],r):"object"===typeof q.exports?q.module.exports=r():q.GeolocationMarker=r();

/**************************************************************************************************************************************

  END  


**************************************************************************************************************************************/

       var locations = []


       var url = 'https://cbi-api-internal-qa.herokuapp.com/v2/beerStores?apiKey=compass-beer&filterUnsold=Y&includeStoreRank=Y&lowerRightBound=37.330966%2C-118.029159&signature=AziYxd1PhDbUvQIAjSBfgb5fs3nsAHeO848/Y4j3FDg%3D&upperLeftBound=37.338737%2C-122.037399';

        // Fetch the latest data.
    fetch(url,{})
    .then((response) => response.json())
    .then((responseJson) => {

      console.log(responseJson.length); 

        for(var i = 0; i < responseJson.length; i++) {
            locations[i] = {lat: responseJson[i].latitude, lng: responseJson[i].longitude};    
        }

           map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: 37.3327, lng: -121.9012}, 
          disableDefaultUI: true
        });

            // Create the DIV to hold the control and call the CenterControl()
        // constructor passing in this DIV.
        var centerControlDiv = document.createElement('div');
        var centerControl = new CenterControl(centerControlDiv, map);

        var upControlDiv = document.createElement('div'); 
        var upControl = new UpControl(upControlDiv, map); 

        var searchInput = document.getElementById("mySearch"); 
        var searchSelector = document.querySelector('.searchBox')
        searchSelector.addEventListener('click', function() {
          //menuOverlayElement.classList.add('menu__overlay--show');

        }); 
         
      
    
        centerControlDiv.index = 2;
        upControlDiv.index = 1; 
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(centerControlDiv); 
        map.controls[google.maps.ControlPosition.LEFT_TOP].push(upControlDiv); 

        //map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(searchControlDiv); 

          //current location marker
           var GeoMarker = new GeolocationMarker(map); 


           //error permission window 
           var testinfowindow = new google.maps.InfoWindow({
          content: "Test"
        });

          
          // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
          
          currentLocation = pos; 
            map.setZoom(16); 
            map.setCenter(pos);
           
          }, function() {
            handleLocationError(true,  testinfowindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false,  testinfowindow, map.getCenter());
        }



          var custommapStyle = [
  {
    featureType: "all",
    elementType: "labels",
    stylers: [
      { visibility: "off" }
    ]
  }
]

map.set('styles',custommapStyle);

         var options = {
        styles: [{
          textColor: 'white',
          height: 100,
          url: "icons/PinOverlap.png",
          width: 100, 
        }]
      }

        var markers = locations.map(function(location, i) {

            //SAVE THE DATA FOR ALL daPINS 
            visiblePins[i] = responseJson[i]; 

           

           var infowindow = new google.maps.InfoWindow({
          content: i.toString()
        });

          var newmarker = new google.maps.Marker({
              position: location,
             icon: "/icons/PinLiquorBlue.png"
          });

          newmarker.addListener('click',function() {
            console.log("Click Click Click"); 
            //infowindow.open(map,newmarker); 

              console.log(infowindow.content); 


              var currentPinIndex = +(infowindow.content); 
              console.log(currentPinIndex); 

              var name = visiblePins[currentPinIndex].store_name; 
              var address = visiblePins[currentPinIndex].address; 
              var cityANDstate = visiblePins[currentPinIndex].city + " , " + visiblePins[currentPinIndex].state; 
              

             var data = { name, address, cityANDstate }; 


            showAccountDetail(data); 
          });

          return newmarker;  
        });

        // Add a marker clusterer to manage the markers.
        var markerCluster = new MarkerClusterer(map, markers,options);
        markerCluster.setCalculator(function(markers,numStyles) {

          var index = 0; 
          var count = markers.length; 
          var dv = count; 
          while(dv !== 0){
            dv = parseInt(dv / 10, 10); 
            index++; 
          }

          index = Math.min(index,numStyles); 
          return {
            text: "", 
            index:index
          }; 
        }); 
      
    
    });






  }
function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  console.log("Current Location Error"); 
        //currentlocationinfoWindow.setPosition(pos);
       // currentlocationinfoWindow.setContent(browserHasGeolocation ?
                             // 'Error: The Geolocation service failed.' :
                             // 'Error: Your browser doesn\'t support geolocation.');
        //currentlocationinfoWindow.open(map);
      }


       // TODO add service worker code here
   if ('serviceWorker' in navigator) {
    navigator.serviceWorker
             .register('/service-worker.js')
             .then((registration) => { 
              console.log('Service Worker Registered'); 
              firebase.messaging().useServiceWorker(registration); 
            });

 }


    </script>
    

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> 

<!-- Latest compiled Bootstrap JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!-- Google Maps  -->
   <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
   <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9p7xIJwPgXx3QrTcx2GX9w3lDCxkou1Y&callback=initMap"
    async defer></script>


</body>
</html>
